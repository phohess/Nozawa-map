<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>野澤滑雪助手 V6</title>
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    <style>
        :root { 
            --primary: #2ecc71; --info: #3498db; --danger: #e74c3c; 
            --bg: #000000; --panel: rgba(20, 20, 20, 0.95); 
        }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; touch-action: none; }
        body { margin: 0; background: var(--bg); color: white; height: 100vh; overflow: hidden; font-family: sans-serif; }

        /* 地圖容器 */
        #viewport { width: 100vw; height: 100vh; position: relative; overflow: hidden; background: #1a1a1a; }
        #map-element { width: 100%; position: relative; transform-origin: 0 0; }
        #ski-map { width: 100%; display: block; filter: contrast(1.1); pointer-events: none; }

        /* 頂部與難度標示 (避開劉海) */
        .top-ui {
            position: fixed; top: env(safe-area-inset-top, 20px); left: 15px; right: 15px;
            z-index: 90; pointer-events: none;
        }
        .difficulty-legend {
            margin-top: 10px; display: flex; flex-direction: column; gap: 5px; align-items: flex-end;
        }
        .diff-item { background: rgba(0,0,0,0.7); padding: 4px 10px; border-radius: 10px; font-size: 10px; display: flex; align-items: center; gap: 5px; }

        /* 底部面板：解決按鈕跑版關鍵 */
        .bottom-panel {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--panel); border-top: 1px solid #333;
            padding: 10px 10px calc(env(safe-area-inset-bottom, 10px) + 10px);
            z-index: 100; display: flex; flex-direction: column; gap: 10px;
        }

        /* 滾動標籤列 */
        .nav-scroll { 
            display: flex; overflow-x: auto; gap: 8px; 
            padding-bottom: 5px; -webkit-overflow-scrolling: touch;
        }
        .nav-tag { 
            flex: 0 0 auto; background: #333; padding: 8px 12px; 
            border-radius: 15px; font-size: 12px; border: 1px solid #444; color: #fff;
        }

        /* 按鈕網格：使用 Flex 確保不超出螢幕 */
        .action-grid { 
            display: flex; width: 100%; gap: 8px; 
        }
        .btn {
            flex: 1; /* 讓所有按鈕平分寬度 */
            background: #444; color: white; border: none; 
            padding: 12px 2px; border-radius: 12px;
            font-size: 11px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            min-width: 0; /* 防止文字撐開按鈕 */
        }
        .btn-home { background: var(--primary); color: #000; }
        .btn-info { background: var(--info); }
        .btn-sos { background: var(--danger); }
    </style>
</head>
<body>

<div class="top-ui">
    <div style="font-weight: 900; font-size: 14px;">NOZAWA 2026</div>
    <div class="difficulty-legend">
        <div class="diff-item"><span style="color:#27ae60">●</span> 初級</div>
        <div class="diff-item"><span style="color:#e67e22">●</span> 中級</div>
        <div class="diff-item"><span style="color:#c0392b">●</span> 高級</div>
    </div>
</div>

<div id="viewport">
    <div id="map-element">
        <img src="nozawa_map.jpg" id="ski-map">
    </div>
</div>

<div class="bottom-panel">
    <div class="nav-scroll">
        <div class="nav-tag" onclick="focusOn(3.5, 55, 12)">山頂</div>
        <div class="nav-tag" onclick="focusOn(2.8, 30, 35)">樂園</div>
        <div class="nav-tag" onclick="focusOn(2.5, 20, 62)">日影</div>
        <div class="nav-tag" onclick="focusOn(2.5, 52, 60)">長坂</div>
        <div class="nav-tag" onclick="focusOn(2.2, 82, 75)">柄澤</div>
    </div>

    <div class="action-grid">
        <button class="btn btn-home" onclick="resetMap()">全身圖</button>
        <button class="btn btn-info" onclick="focusOn(2.4, 93, 50)">資訊欄</button>
        <button class="btn" onclick="window.open('https://nozawaski.com/report/')">纜車狀態</button>
        <button class="btn btn-sos" onclick="window.location.href='tel:0269853456'">救援 SOS</button>
    </div>
</div>

<script>
    const elem = document.getElementById('map-element');
    const img = document.getElementById('ski-map');

    const pz = Panzoom(elem, {
        maxScale: 6,
        minScale: 1,
        contain: 'outside',
        animate: true,
        duration: 350
    });

    document.getElementById('viewport').addEventListener('wheel', pz.zoomWithWheel);

    /**
     * 新版精確對焦：修正座標跑掉問題
     */
    function focusOn(s, xPct, yPct) {
        if (navigator.vibrate) navigator.vibrate(40);

        // 獲取圖片當前實際呈現的寬高 (未縮放前)
        const mapW = img.offsetWidth;
        const mapH = img.offsetHeight;

        // 計算縮放後的目標點絕對位置
        const targetX = (mapW * (xPct / 100)) * s;
        const targetY = (mapH * (yPct / 100)) * s;

        // 計算平移量：讓目標點出現在螢幕中心
        // 考慮到下方按鈕面板遮擋，中心點向上偏移 50px
        const panX = (window.innerWidth / 2) - targetX;
        const panY = (window.innerHeight / 2) - targetY - 50;

        pz.zoom(s);
        setTimeout(() => {
            pz.pan(panX, panY);
        }, 50);
    }

    function resetMap() {
        pz.reset();
    }

    // 雙擊重置
    document.getElementById('viewport').addEventListener('dblclick', (e) => {
        e.preventDefault();
        resetMap();
    });
</script>

</body>
</html>
